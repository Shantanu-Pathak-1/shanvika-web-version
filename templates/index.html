<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shanvika üå∏ AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Purane style mein body ka height fix karo */
body { 
    font-family: 'Segoe UI', sans-serif; 
    overflow: hidden; 
    transition: 0.3s; 
    background: transparent;
    /* Mobile Browser Address Bar Fix */
    height: 100vh; /* Fallback */
    height: 100dvh; /* Asli Mobile Height */
}

/* Input Container ko Fixed kar denge taaki wo hile nahi */
.input-fixed-bottom {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 50;
    padding: 1rem;
    background: linear-gradient(to top, #000000, rgba(0,0,0,0.9), transparent);
}
        body { font-family: 'Segoe UI', sans-serif; overflow: hidden; transition: 0.3s; background: transparent; }
        
        /* THEMES */
        body.dark-mode { color: #e0e0e0; }
        body.dark-mode input { color: white; }
        body.dark-mode .sidebar-style { background: rgba(0,0,0,0.8); border-right: 1px solid rgba(255,255,255,0.1); }
        
        body.light-mode { background-color: #f8f9fa !important; color: #1a1a1a !important; }
        body.light-mode canvas { display: none !important; }
        body.light-mode .sidebar-style { background: #ffffff !important; border-right: 1px solid #e5e7eb !important; box-shadow: 2px 0 15px rgba(0,0,0,0.05); }
        body.light-mode .nav-label { color: #333 !important; }
        body.light-mode .text-gray-400 { color: #666 !important; }
        body.light-mode header { background: #ffffff !important; border-bottom: 1px solid #e5e7eb; }
        
        /* Messages & Input Light Mode */
        body.light-mode .input-container { background: #ffffff; border: 1px solid #d1d5db; color: black; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        body.light-mode input { color: #1a1a1a !important; }
        body.light-mode input::placeholder { color: #6b7280; }
        body.light-mode .msg-ai { background: #ffffff; color: #1f2937; border: 1px solid #e5e7eb; }

        /* VANTA */
        body.dark-mode canvas { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; }

        /* Z-INDEX LAYERING - FIXED */
        aside { position: relative; z-index: 50; }
        main { position: relative; z-index: 10; }
        .modal, .dropdown-menu { position: relative; z-index: 100; }

        /* SIDEBAR */
        #sidebar { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 4.5rem; display: flex; flex-direction: column; }
        @media (min-width: 768px) { #sidebar:hover, #sidebar.locked { width: 18rem; } }
        @media (max-width: 767px) { 
            #sidebar { position: fixed; left: -100%; top:0; bottom:0; width: 80%; z-index: 60; }
            #sidebar.mobile-open { left: 0; }
        }

        @media (min-width: 768px) {
            #sidebar:not(:hover):not(.locked) .nav-label, 
            #sidebar:not(:hover):not(.locked) .profile-info { display: none; }
            #sidebar:not(:hover):not(.locked) .sidebar-content { justify-content: center; }
        }
        .nav-label { margin-left: 12px; white-space: nowrap; }

        /* CHAT BUBBLES */
        .msg-user { background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 18px 18px 0 18px; color: white; }
        .msg-ai { background: rgba(30,30,30,0.8); border-radius: 18px 18px 18px 0; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }

        /* INPUT AREA */
        .input-wrapper { max-width: 48rem; margin: 0 auto; position: relative; }
        .input-container { background: rgba(30,30,30,0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; backdrop-filter: blur(10px); z-index: 50; }
        
        .mode-scroll::-webkit-scrollbar { display: none; }
        .mode-btn {
            white-space: nowrap; padding: 6px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: 0.2s;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #ccc;
        }
        .mode-btn.active { background: linear-gradient(to right, #ec4899, #8b5cf6); border: none; color: white; font-weight: bold; }
        body.light-mode .mode-btn { background: #e5e7eb; border: 1px solid #d1d5db; color: #4b5563; }
        body.light-mode .mode-btn.active { color: white; background: linear-gradient(to right, #ec4899, #8b5cf6); border: none; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 100; }
        .modal-content { background: #1e1e1e; margin: 15% auto; padding: 20px; border-radius: 16px; width: 90%; max-width: 400px; border: 1px solid #333; color: white; }
        body.light-mode .modal-content { background: white; color: black; border: 1px solid #ccc; }

        .dropdown-menu { display: none; position: fixed; z-index: 9999; background: #222; border-radius: 10px; padding: 5px; border: 1px solid #444; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 8px 12px; cursor: pointer; color: #eee; display: flex; gap: 10px; border-radius: 6px; }
        .dropdown-item:hover { background: #333; }
    </style>
</head>
<body id="vanta-bg" class="flex h-screen w-full dark-mode">

    <aside id="sidebar" class="sidebar-style backdrop-blur-md shadow-2xl">
        <div class="flex-1 flex flex-col overflow-hidden">
            <div class="p-4 flex items-center justify-between h-16 border-b border-white/5 sidebar-content">
                <div class="flex items-center gap-3 cursor-pointer overflow-hidden hover:opacity-80 transition" onclick="createNewChat()">
                    <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-pink-500 to-purple-600 flex items-center justify-center flex-shrink-0 text-sm shadow-lg">üå∏</div>
                    <span class="nav-label font-bold text-lg">Shanvika</span>
                </div>
                <button onclick="createNewChat()" class="nav-label text-gray-400 hover:text-white" title="New Chat"><i class="fas fa-edit text-lg"></i></button>
            </div>
            <div class="mt-2 px-2 flex-1 overflow-y-auto" id="history-list"></div>
        </div>
        <div class="p-4 border-t border-white/5">
            <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-white/5 transition sidebar-content group">
                <div class="w-9 h-9 rounded-full bg-gray-700 overflow-hidden flex-shrink-0 cursor-pointer border border-gray-600" onclick="openProfileModal()">
                    <img id="profile-img-sidebar" src="" class="w-full h-full object-cover">
                </div>
                <div class="profile-info flex-1 overflow-hidden cursor-pointer" onclick="openProfileModal()">
                    <div id="profile-name-sidebar" class="text-sm font-bold truncate">Loading...</div>
                    <div class="text-xs text-gray-400">Pro Plan</div>
                </div>
                <button class="text-gray-400 hover:text-white ml-2 nav-label" onclick="openSettingsModal()"><i class="fas fa-cog"></i></button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <header class="md:hidden flex justify-between p-4 bg-black/50 backdrop-blur-md z-20">
            <span class="font-bold text-white text-xl">üå∏ Shanvika</span>
            <button onclick="document.getElementById('sidebar').classList.toggle('mobile-open')" class="text-white"><i class="fas fa-bars"></i></button>
        </header>

        <div id="chat-box" class="flex-1 overflow-y-auto p-4 pb-48 scroll-smooth">
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full opacity-60 text-center">
                <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-pink-500 to-purple-600 flex items-center justify-center text-4xl mb-4 shadow-2xl">üå∏</div>
                <h2 class="text-2xl font-bold">Namaste!</h2>
                <p>Select a mode below to start.</p>
            </div>
        </div>

        <div class="absolute bottom-0 w-full p-4 z-50 bg-gradient-to-t from-black via-black/90 to-transparent">
            <div class="input-wrapper flex flex-col gap-3">
                
                <div class="flex gap-2 overflow-x-auto mode-scroll pb-1 justify-center">
                    <div class="mode-btn active" onclick="setMode('chat', this)">üí¨ Chat</div>
                    <div class="mode-btn" onclick="setMode('coding', this)">üíª Coding</div>
                    <div class="mode-btn" onclick="setMode('image_gen', this)">üé® Image Gen</div>
                    <div class="mode-btn" onclick="setMode('research', this)">üîç Research</div>
                    <div class="mode-btn" onclick="setMode('anime', this)">üå∏ Anime</div>
                    <div class="mode-btn" onclick="setMode('video', this)">üé• Video</div>
                </div>

                <form class="input-container flex items-center p-2 pr-2 shadow-2xl" onsubmit="event.preventDefault(); sendMessage();">
                    <button type="button" class="w-10 h-10 flex items-center justify-center rounded-full text-gray-400 hover:text-white hover:bg-white/10" onclick="document.getElementById('file-upload').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(this)">

                    <input type="text" id="user-input" class="flex-1 bg-transparent border-none outline-none px-3 py-3" placeholder="Message Shanvika..." autocomplete="off">
                    
                    <button type="submit" class="w-10 h-10 flex items-center justify-center rounded-full bg-white text-black hover:bg-gray-200 shadow-md transition transform active:scale-95">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </form>
                
                <p class="text-center text-[10px] text-gray-500">Shanvika v5.0 ‚Ä¢ All Systems Active</p>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between mb-4"><h2 class="text-xl font-bold">Settings</h2><button onclick="closeModal('settings-modal')"><i class="fas fa-times"></i></button></div>
            <div class="flex justify-between p-3 bg-white/5 rounded mb-4"><span>Theme</span><button id="theme-btn" onclick="toggleTheme()" class="bg-blue-600 px-3 py-1 rounded text-sm">Dark</button></div>
            <button onclick="closeModal('settings-modal'); openModal('profile-modal')" class="w-full p-2 bg-white/10 rounded">‚úèÔ∏è Edit Profile</button>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content text-center">
            <h2 class="text-xl font-bold mb-4">Edit Profile</h2>
            <div class="w-24 h-24 mx-auto mb-4 rounded-full overflow-hidden border-2 border-blue-500 relative cursor-pointer group" onclick="document.getElementById('avatar-upload').click()">
                <img id="profile-img-modal" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100"><i class="fas fa-camera text-white"></i></div>
            </div>
            <input type="file" id="avatar-upload" class="hidden" onchange="uploadAvatar(this)">
            <input type="text" id="profile-name-input" class="w-full bg-transparent border border-gray-500 rounded p-2 text-center text-white mb-4">
            <button onclick="saveProfile()" class="bg-blue-600 w-full py-2 rounded">Save</button>
        </div>
    </div>

    <div id="dropdown" class="dropdown-menu"><div class="dropdown-item" id="act-rename">Rename</div><div class="dropdown-item" id="act-delete" style="color:#ff5555">Delete</div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.halo.min.js"></script>

<script>
        // --- CONFIG ---
        let currentMode = 'chat';
        let currentSessionId = null;
        let vantaEffect = null;
        let isDarkMode = true;
        let selectedImageBase64 = null; // üëà Store Image Data

        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            loadHistory(); 
            initVanta();
        });

        // --- VANTA ---
        function initVanta() {
            if (!vantaEffect && isDarkMode) {
                try {
                    vantaEffect = VANTA.HALO({
                        el: "#vanta-bg", mouseControls: true, touchControls: true, minHeight: 200, minWidth: 200,
                        backgroundColor: 0x171718, baseColor: 0x1a59, amplitudeFactor: 3
                    });
                } catch(e) { console.log("Vanta init failed:", e); }
            }
        }

        // --- THEME ---
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.className = isDarkMode ? "flex h-screen w-full dark-mode" : "flex h-screen w-full light-mode";
            document.getElementById('theme-btn').innerText = isDarkMode ? "Dark" : "Light";
            
            const footer = document.querySelector('.absolute.bottom-0');
            if (!isDarkMode) {
                footer.classList.remove('bg-gradient-to-t', 'from-black', 'via-black/90');
                footer.style.background = 'transparent'; 
            } else {
                footer.classList.add('bg-gradient-to-t', 'from-black', 'via-black/90');
                footer.style.background = '';
            }
            if(isDarkMode) initVanta(); else { if(vantaEffect) { vantaEffect.destroy(); vantaEffect = null; } }
        }

        // --- PROFILE ---
        async function loadProfile() {
            try {
                const res = await fetch('/api/profile');
                const data = await res.json();
                const avatarUrl = data.avatar + "?t=" + new Date().getTime();
                document.getElementById('profile-img-sidebar').src = avatarUrl;
                document.getElementById('profile-img-modal').src = avatarUrl;
                document.getElementById('profile-name-sidebar').innerText = data.name;
                document.getElementById('profile-name-input').value = data.name;
            } catch(e){ console.error("Profile load error:", e); }
        }
        
        async function saveProfile() {
            const name = document.getElementById('profile-name-input').value;
            try {
                await fetch('/api/update_profile_name', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({name}) 
                });
                loadProfile(); closeModal('profile-modal');
            } catch(e) { console.error("Save profile error:", e); }
        }
        
        async function uploadAvatar(input) {
            if(!input.files[0]) return;
            const fd = new FormData(); fd.append("file", input.files[0]);
            try { await fetch('/api/update_avatar', { method: 'POST', body: fd }); loadProfile(); } catch(e) { console.error("Avatar upload error:", e); }
        }

        // --- CHAT & IMAGE ---
        function setMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const placeholders = {
                'chat': 'Message Shanvika...', 'coding': 'Ask for code help...',
                'image_gen': 'Describe image to generate...', 'research': 'What do you want to research?...',
                'anime': 'Ask about anime...', 'video': 'Describe your video idea...'
            };
            document.getElementById('user-input').placeholder = placeholders[mode] || 'Message Shanvika...';
        }

        // üñºÔ∏è HANDLE FILE SELECTION
        function handleFileUpload(input) { 
            const file = input.files[0];
            if(!file) return;

            // Convert to Base64
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageBase64 = e.target.result;
                // UI feedback
                const btn = document.querySelector('.fa-paperclip').parentElement;
                btn.style.color = '#4ade80'; // Green color
                document.getElementById('user-input').placeholder = "Image selected! Type question & send...";
                document.getElementById('user-input').focus();
            };
            reader.readAsDataURL(file);
        }

        async function createNewChat() {
            try {
                const res = await fetch('/api/new_chat');
                const data = await res.json();
                currentSessionId = data.session_id;
                
                document.getElementById('chat-box').innerHTML = `
                    <div id="welcome-screen" class="flex flex-col items-center justify-center h-full opacity-60 text-center">
                        <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-pink-500 to-purple-600 flex items-center justify-center text-4xl mb-4 shadow-2xl">üå∏</div>
                        <h2 class="text-2xl font-bold">Namaste!</h2>
                        <p>Select a mode below to start.</p>
                    </div>`;
                await loadHistory();
            } catch(e) { console.error("Create chat error:", e); }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const msg = input.value.trim();
            
            if(!msg && !selectedImageBase64) return; // Msg or Image required
            
            if(!currentSessionId) {
                await createNewChat();
                await new Promise(r => setTimeout(r, 200)); 
            }

            // Show User Message with Image Preview if exists
            let userDisplayHtml = msg;
            if(selectedImageBase64) {
                userDisplayHtml += `<br><img src="${selectedImageBase64}" class="mt-2 rounded-lg max-h-40 border border-white/20">`;
            }
            appendMessage(userDisplayHtml, 'user');
            
            input.value = '';
            
            // Reset Upload Button
            const btn = document.querySelector('.fa-paperclip').parentElement;
            btn.style.color = ''; 

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message: msg || "Analyze this image", // Fallback text if empty
                        session_id: currentSessionId, 
                        mode: currentMode,
                        image: selectedImageBase64 // üëà Sending Image
                    })
                });
                
                // Clear selected image after sending
                selectedImageBase64 = null;
                document.getElementById('file-upload').value = ""; // Clear input

                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();
                appendMessage(data.reply, 'ai');
                loadHistory(); 
                
            } catch(e) { 
                console.error("Send message error:", e);
                appendMessage("‚ö†Ô∏è Error: Could not connect to Shanvika.", 'ai'); 
            }
        }

        function appendMessage(htmlContent, role) {
            const welcome = document.getElementById('welcome-screen');
            if(welcome) welcome.style.display = 'none';

            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `flex gap-4 mb-4 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            const avatar = role === 'ai' ? 
                '<div class="w-8 h-8 rounded-full bg-pink-600 flex items-center justify-center text-xs text-white">üå∏</div>' : 
                '<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs text-white">U</div>';
            
            div.innerHTML = `${avatar}<div class="${role === 'ai' ? 'msg-ai' : 'msg-user'} p-3 px-4 max-w-[85%] text-sm leading-relaxed shadow-md">${htmlContent}</div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- HISTORY ---
        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const data = await res.json();
                const list = document.getElementById('history-list');
                list.innerHTML = "";
                data.history.forEach(chat => {
                    const div = document.createElement('div');
                    div.className = "p-3 rounded-lg flex items-center justify-between cursor-pointer hover:bg-white/5 mb-1 group transition";
                    div.onclick = (e) => { if(!e.target.closest('button')) loadChat(chat.id); };
                    div.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><i class="far fa-comment-alt text-gray-500"></i><span class="nav-label text-gray-400 text-sm truncate w-32 group-hover:text-white transition">${chat.title}</span></div><button class="text-gray-500 hover:text-white opacity-0 group-hover:opacity-100 transition" onclick="showMenu(event, '${chat.id}')"><i class="fas fa-ellipsis-h"></i></button>`;
                    list.appendChild(div);
                });
            } catch(e){ console.error(e); }
        }
        
        async function loadChat(sid) {
            try {
                currentSessionId = sid;
                const res = await fetch(`/api/chat/${sid}`);
                const data = await res.json();
                document.getElementById('chat-box').innerHTML = '';
                data.messages.forEach(m => { appendMessage(m.content, m.role === 'user' ? 'user' : 'ai'); });
            } catch(e) { console.error(e); }
        }

        // Modals & Menu
        function openSettingsModal() { document.getElementById('settings-modal').style.display = 'block'; }
        function openProfileModal() { document.getElementById('profile-modal').style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        const dd = document.getElementById('dropdown');
        function showMenu(e, sid) {
            e.stopPropagation();
            const rect = e.currentTarget.getBoundingClientRect();
            dd.style.top = rect.bottom + 'px'; dd.style.left = rect.left + 'px'; dd.style.display = 'block';
            document.getElementById('act-rename').onclick = async () => { const t = prompt("Rename:"); if(t) { await fetch('/api/rename_chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({session_id: sid, new_title: t}) }); loadHistory(); } dd.style.display = 'none'; };
            document.getElementById('act-delete').onclick = async () => { if(confirm("Delete?")) { await fetch(`/api/delete_chat/${sid}`, {method:'DELETE'}); if(currentSessionId === sid) { currentSessionId = null; createNewChat(); } loadHistory(); } dd.style.display = 'none'; };
        }
        window.onclick = (e) => { if(!dd.contains(e.target) && !e.target.closest('.fa-ellipsis-h')) { dd.style.display = 'none'; } }
    </script>
</body>
</html>
